<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Gráfico de Distância - MDF</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background-color: #f5f5f5;
      text-align: center;
    }
    canvas {
      max-width: 100%;
    }
    .valor {
      font-size: 2em;
      margin-bottom: 20px;
      color: #0077cc;
    }
    .botao {
      margin-top: 10px;
      padding: 8px 15px;
      font-size: 1em;
      background: #0077cc;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>Distância Ultrassônica (Firebase)</h1>
  <div class="valor" id="distancia">Carregando...</div>
  <canvas id="grafico" height="100"></canvas>
  <button class="botao" onclick="resetZoom()">Resetar Zoom</button>

  <script>
    let ctx = document.getElementById('grafico').getContext('2d');
    let data = {
      labels: [],
      datasets: [{
        label: 'Distância (cm)',
        data: [],
        fill: false,
        borderColor: 'blue',
        tension: 0.2,
        pointRadius: 0
      }]
    };

    let chart = new Chart(ctx, {
      type: 'line',
      data: data,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            display: false
          },
          y: {
            beginAtZero: false,
            suggestedMin: 0,
            suggestedMax: 100
          }
        },
        plugins: {
          zoom: {
            zoom: {
              wheel: {
                enabled: true
              },
              pinch: {
                enabled: true
              },
              mode: 'xy'
            },
            pan: {
              enabled: true,
              mode: 'xy'
            }
          }
        }
      }
    });

    function resetZoom() {
      chart.resetZoom();
    }

    async function carregarDistancia() {
      try {
        const response = await fetch('https://mdfsensor-44da4-default-rtdb.firebaseio.com/leituras.json');
        const dados = await response.json();

        if (dados && dados.distancia !== undefined) {
          const valor = dados.distancia.toFixed(2);
          document.getElementById("distancia").textContent = valor + " cm";

          // Adiciona ao gráfico
          if (data.labels.length >= 300) {
            data.labels.shift();
            data.datasets[0].data.shift();
          }

          data.labels.push("");  // ou timestamp se quiser
          data.datasets[0].data.push(parseFloat(valor));

          let max = Math.max(...data.datasets[0].data);
          let min = Math.min(...data.datasets[0].data);

          chart.options.scales.y.min = Math.floor((min - 1) * 10) / 10;
          chart.options.scales.y.max = Math.ceil((max + 1) * 10) / 10;

          chart.update();
        }
      } catch (error) {
        console.error("Erro ao buscar Firebase:", error);
        document.getElementById("distancia").textContent = "Erro na leitura";
      }
    }

    setInterval(carregarDistancia, 1000);
    carregarDistancia();
  </script>
</body>
</html>
